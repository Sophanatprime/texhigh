% !TEX program=xelatex
% !TEX options=-synctex=1 -shell-escape -interaction=nonstopmode -file-line-error "%DOC%"
\documentclass[zihao=-4,fontset=fandol]{ctexart}
\usepackage[hmargin=2cm,vmargin=2.4cm]{geometry}
\usepackage{amsmath,amssymb}
\usepackage{hologo}
\usepackage[many]{tcolorbox}
\usepackage[color,tikz]{texhigh}
\usepackage[colorlinks]{hyperref}
\ifdefined\xeCJKsetup
  \SetKeys[texhigh/high]{
    font=\ttfamily\xeCJKsetup{CJKecglue={\hskip 0pt plus 0.08\baselineskip}}\raggedright,
  }
\else
  \SetKeys[texhigh/high]{
    font=\ttfamily\raggedright,
  }
\fi
\newfontfamily\emojifont{Noto Emoji}
% è‹¥ç³»ç»Ÿæ²¡æœ‰è¿™äº›å­—ä½“ä¼šè‡ªåŠ¨å¿½ç•¥
\SetKeys[texhigh/layout]{fonts={Segoe UI,Segoe UI Symbol,Arial,Microsoft YaHei UI,PingFang SC,FandolHei}}
\SetKeys[texhigh/high]{cache-dir=texhigh-cache/, % cache-dir ä¸è¦å¿˜è®°åŠ  /ï¼Œæ³¨æ„ï¼šéœ€è¦å…ˆåˆ›å»º texhigh-cache æ–‡ä»¶å¤¹ï¼ï¼
  cs-category*={texhigh}{^.{0,3}?texhigh.+|^TH.+|^TeXHigh$|^kaomoji$}{\THPASS}}
\tcbset{listing engine=texhigh, listing file=texhigh-cache/\jobname.listing}
\newcounter{example}
\newtcblisting[use counter=example, number format=\arabic]
  {examcode}[2][]{listing and text, 
  title=ä»£ç  \thetcbcounter, enhanced,
  comment={#2},
  left=2mm, right=2mm, top=2mm, bottom=2mm,
  sharp corners=downhill, arc=12pt, %skin=bicolor,
  fontupper=\linespread{1}\selectfont, left=6pt,
  colback=blue!1!white, colframe=blue!75!black,colbacklower=white,
  segmentation style={draw=blue,thick,solid},
  attach boxed title to top right={yshift=-\tcboxedtitleheight},
  boxed title style={
    colframe=blue!75!black,colback=blue!15!white,
    sharp corners=downhill,arc=12pt,
  },
  coltitle=blue!90!black, fonttitle=\bfseries,
  before skip balanced=2bp plus .5\baselineskip,
  after skip balanced=2bp plus .5\baselineskip,
  breakable,
  #1
}
\ProvideDocumentCommand{\cs}{m}{\texttt{\textbackslash\detokenize{#1}}}
\ProvideDocumentCommand{\meta}{m}{\ensuremath\langle\textit{#1}\ensuremath\rangle}
\ProvideDocumentCommand{\oarg}{m}{\texttt[\meta{#1}\texttt]}
\ProvideDocumentCommand{\marg}{m}{\texttt\{\meta{#1}\texttt\}}
\begin{document}

\title{é«˜äº® \TeX å’Œ \LaTeX3 ä»£ç â€”â€”ä½¿ç”¨\textsf{texhigh} å®åŒ…}
\author{é›¾æœˆ\thanks{longaster@163.com}}
\maketitle

\textsf{texhigh} å®åŒ…\footnote{\url{https://github.com/Sophanatprime/texhigh}}%
æ˜¯ä¸“ç”¨æ¥é«˜äº® \TeX æ–‡ä»¶çš„å®åŒ…ã€‚åŸºäºç”± Rust ç¼–å†™çš„å‘½ä»¤è¡Œå·¥å…·
texhigh\footnote{\url{https://github.com/Sophanatprime/texhigh-rs}}ï¼Œ
å¤„ç† 1.24MB å·¦å³ï¼ˆ37,700 ä½™è¡Œï¼‰çš„ \texttt{expl3-code.tex} åªéœ€ 0.15s å·¦å³
ï¼ˆæ“ä½œç³»ç»Ÿä¸º Windowsï¼ŒCPU ä¸º i7-12700Hï¼‰ï¼Œ
å¤„ç†é€Ÿåº¦çº¦ä¸º \textsf{minted} å®åŒ…ä½¿ç”¨çš„ pygmentizeï¼ˆçº¦ 2.75sï¼‰çš„ 18 å€ï¼Œ
texhigh çš„å¢å¼ºæ¨¡å¼ä¹Ÿæ¯”å®ƒå¿« 10 åˆ° 16 å€ï¼ˆçº¦ 0.165sï¼‰ã€‚
å¯¹äºæ™®é€šå¤§å°çš„ \TeX ä»£ç ï¼Œå¤„ç†å®ƒä»¬æ‰€éœ€çš„æ—¶é—´ç›¸æ¯”äº \TeX æ–‡ä»¶æœ¬èº«ç¼–è¯‘æ‰€éœ€çš„æ—¶é—´ï¼Œ
å·²ç»å¯ä»¥å¿½ç•¥ä¸è®°ã€‚

\textsf{texhigh} ä¸»è¦æ˜¯åœ¨ \LaTeX ä¸­ä¸º texhigh å‘½ä»¤è¡Œå·¥å…·æä¾›äº¤äº’æ¥å£ã€‚è¿™è¦æ±‚åœ¨ç¼–è¯‘ \TeX
æ–‡ä»¶æ—¶å¯ç”¨ \texttt{--shell-escape}ã€‚

texhigh é™¤äº†å¯ç”¨äºé«˜äº® \TeX æ–‡ä»¶ï¼Œè¿˜æ”¯æŒè®¡ç®—æ–‡å­—çš„å¸ƒå±€ã€‚
åŸºäºæ­¤ç‰¹æ€§ï¼Œ\textsf{texhigh} æä¾›äº†è¾“å‡ºé¢œæ–‡å­—çš„åŠŸèƒ½ï¼š
\kaomoji{Îµ(â”¬â”¬ï¹â”¬â”¬)3} ï¼Œåªéœ€ä½¿ç”¨ \texhighverb{\kaomoji}\texttt\{\ensuremath{\langle}\verb|é¢œæ–‡å­—|\ensuremath{\rangle}\texttt\}ã€‚
é»˜è®¤ä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼Œä¹Ÿå¯è‡ªè¡Œè®¾ç½® \kaomoji{ãƒ¾(â‰§â–½â‰¦*)o}ã€‚

% https://emojicombos.com/cute-kaomoji
\kaomoji{à¬˜(à©­*ËŠáµ•Ë‹)à©­* à©ˆâ™¡â€§â‚ŠËš}\quad
\kaomoji{ à¬ª(à¹‘â€¢á´—â€¢à¹‘)à¬“ â™¡}\quad
\kaomoji{ à«®â‚Ë¶ â€¢. â€¢ â‘…â‚áƒ â™¡}\quad
% \kaomoji{à»’ê’°â à¾€à½²áµ” áµ• áµ” ê’±â à¾€à½²à§§}\quad
\kaomoji{à»’ê’°â à¾€à½²â€†áµ” áµ• áµ”ê’±â à¾€à½²à§§}\quad
\kaomoji{(â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»}

% ç”±äº texhigh ä½¿ç”¨çš„ cosmic-text åº“åœ¨å¤„ç† font fallback æ—¶ä»æœ‰ç¼ºé™·ï¼Œ
ä½¿ç”¨é¢œæ–‡å­—æ—¶å¯èƒ½ä¼šé‡åˆ°å­—ä½“é—®é¢˜ï¼Œè¿™æ—¶åœ¨å­—ç¬¦é—´æ’å…¥é›¶å®½è¯è¿æ¥ç¬¦ \texttt{U+2060} æˆ–å¯è§£å†³ã€‚
% è¿™ä¼šå½±å“å­—ç°‡çš„åˆ†å‰²ï¼Œä»è€Œä¸ºæŸäº›å­—ç¬¦æŸ¥æ‰¾æ›´åŠ åˆé€‚çš„å­—ä½“ã€‚

ä½¿ç”¨ \texhighverb|\kaomoji*| è¿˜æ”¯æŒæŠŠå•è¡Œæ–‡å­—è¾“å‡ºä¸ºå›¾ç‰‡ï¼š
\begin{examcode}[texhigh options={
  % è¿™é‡Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾å­—ç¬¦çš„ç±»åˆ«ï¼Œä¸‹é¢çš„æ­£åˆ™è¡¨è¾¾å¼è¡¨ç¤ºæ˜¯ Emoji ä½†ä¸æ˜¯ ASCII å­—ç¬¦
  char-category*={emoji}{[\p{Emoji}--\p{ASCII}]}{\mbox{\emojifont #1}} % ASCII digit is emoji!
}]{}
% è¿™é‡Œçš„ fontsize å½±å“å›¾ç‰‡çš„å¤§å°ï¼Œä»è€Œå½±å“æ¸…æ™°åº¦
\kaomoji*[fontsize*=\Huge]{ğŸ€ğŸƒğŸ…ğŸ‡ğŸ‰ğŸğŸğŸğŸ’ğŸ“ğŸ•ğŸ–}{\includegraphics[height=12bp]}

\kaomoji*[fontsize=50bp]{\Uchar"1F43C }{\includegraphics[height=25bp]}
\end{examcode}

ä¹Ÿå¯ä»¥è‡ªå·±å°è£…ä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ï¼š
\begin{examcode}[texhigh options={
  use-ctab=latexcode,
  char-category*={emoji}{[\p{Emoji}--\p{ASCII}]}{\mbox{\emojifont #1}} % ASCII digit is emoji!
}]{}
\makeatletter
% fonts é”®ç”¨äºè®¾ç½®é¢å¤–çš„å­—ä½“ã€‚texhigh ä¼šæŸ¥æ‰¾ç³»ç»Ÿå­—ä½“ï¼Œä¸€èˆ¬æ— éœ€å¦è¡Œè®¾ç½®
\NewDocumentCommand\inmoji{ D<>{\f@size\p@} ={fonts+} O{} m }
  {\kaomoji*[fontsize={(#1)*3},#2]{#3}
    {\includegraphics[height=\dimeval{#1}]}}
\makeatother
\inmoji{ğŸ•ğŸ•‘ğŸ•’ğŸ•“ğŸ•”ğŸ••ğŸ•–ğŸ•—ğŸ•˜ğŸ•™ğŸ•šğŸ•›} \inmoji{^o^y}
\end{examcode}

\textsf{texhigh} æä¾› \texhighverb|\texhighverbã€\texhighfileã€\texhighinput|
è¿™å‡ ä¸ªå‘½ä»¤ä»¥åŠä¸€ä¸ª \textsf{texhigh} ç¯å¢ƒç”¨äºé«˜äº® \TeX ä»£ç ã€‚

%% texhigh é»˜è®¤ä¼šä½¿ç”¨ \raggedrightï¼Œå®ƒä¼šè®¾ç½® \parindent ä¸º 0ptï¼Œå› æ­¤éœ€è¦å…ˆè¿›å…¥æ°´å¹³æ¨¡å¼
\leavevmode
\texhighverb{\texhighverb} ç”¨æ³•å’Œ \texhighverb{\verb} ç±»ä¼¼ï¼Œä½†æ²¡æœ‰å¸¦æ˜Ÿå·çš„ç‰ˆæœ¬ï¼Œ
å®ƒä¸èƒ½ä½œä¸ºå…¶å®ƒå‘½ä»¤çš„å‚æ•°ï¼›
\texhighverb{\texhightext} ç”¨äºé«˜äº®æ–‡å­—ï¼Œä¸€èˆ¬ç”¨äºé«˜äº®å·²ç»å¤„ç†è¿‡çš„æ–‡æœ¬ï¼Œ
å’Œ \texhighverb{\texhighverb} ç›¸æ¯”ï¼Œå®ƒå¯ä»¥ä½œä¸ºå‘½ä»¤çš„å‚æ•°ã€‚
\texhighverb{\texhighfile} ç”¨äºé«˜äº®ä¸€ä¸ªæ–‡ä»¶ï¼Œ
\texhighverb{\texhighinput} åˆ™ç”¨äºå¯¼å…¥ä¸€ä¸ªå·²ç»è¢«å¤„ç†è¿‡çš„æ–‡ä»¶ã€‚

\textsf{texhigh} è¿˜æœ‰å¾ˆå¼ºçš„å¯é…ç½®æ€§ã€‚

ä¸ºäº†å®ç°å¤„ç† \TeX æºç ä¸è¾“å‡ºç»“æœçš„åˆ†ç¦»ï¼Œ\textsf{texhigh} ä½¿ç”¨â€œç±»å‹â€å’Œâ€œç±»åˆ«â€æ¥åŒºåˆ†ä¸åŒçš„è®°å·ã€‚
å­—ç¬¦å’Œæ§åˆ¶åºåˆ—æ˜¯ä¸åŒçš„â€œç±»å‹â€ï¼Œæ§åˆ¶åºåˆ—ä¹‹é—´å¯ä»¥æœ‰ä¸åŒçš„â€œç±»åˆ«â€ï¼Œä¾‹å¦‚æ˜¯åŸè¯­ã€\LaTeX3 å‡½æ•°ç­‰ã€‚
ç±»å‹ä¸å¯æ”¹å˜ï¼Œè€Œâ€œç±»åˆ«â€å¯ä»¥è‡ªç”±ä¿®æ”¹ã€‚

æ¯ä¸ªç±»å‹éƒ½æœ‰ä¸€äº›å‘½ä»¤ç”¨äºæ›´æ”¹å®ƒä»¬çš„â€œç±»åˆ«â€çš„æ˜¾ç¤ºæ•ˆæœï¼Œå¦‚ï¼Œå¯¹äºä¸€ä¸ªæ§åˆ¶åºåˆ—ï¼Œå¯ä»¥ä½¿ç”¨
\texhighverb|\THSetClassCS| æ”¹å˜æ˜¾ç¤ºæ•ˆæœã€‚å¯ä»¥ä¸ºå®ƒä»¬è®¾ç½®å‰æ™¯è‰²ã€èƒŒæ™¯è‰²ï¼Œ
ç”šè‡³æ¸å˜è‰²å’Œåº•çº¹ç­‰ç­‰ã€‚å®é™…ä¸Šæ™®é€šæ–‡å­—å¯ä»¥æ˜¾ç¤ºæˆä»€ä¹ˆæ•ˆæœï¼Œå®ƒä»¬å°±å¯ä»¥åšåˆ°åŒæ ·çš„æ•ˆæœã€‚
å…·ä½“ä¿®æ”¹æ–¹å¼å¯ä»¥å‚è€ƒæ–‡æœ« \texttt{basic} æ ·å¼çš„æºç ã€‚

\textsf{texhigh} åˆ©ç”¨ \textsf{tikz} å®ç°äº†æ¸å˜å’Œåº•çº¹æ•ˆæœï¼ŒåŒæ—¶ä¹Ÿå¯ç›´æ¥é›†æˆåˆ°
\textsf{tcolorbox} å®åŒ…ä¸­ã€‚åªéœ€è¦åœ¨åŠ è½½ \textsf{texhigh} ä¹‹å‰åŠ è½½è¿™å‡ ä¸ªå®åŒ…ã€‚
\begin{examcode}[listing only]{}
\usepackage{tikz}
\usepackage{tcolorbox}
\usepackage{texhigh}
\tcbset{listing engine=texhigh} % ä½¿ç”¨è¿™ä¸ªå³å¯åˆ‡æ¢è‡³ texhigh 
% è‹¥ä½¿ç”¨ xeCJKï¼Œå³åœ¨ XeLaTeX ä¸­ä½¿ç”¨ ctexï¼Œæœ€å¥½è®¾ç½®
\SetKeys[texhigh/high]{
  font=\ttfamily\xeCJKsetup{CJKecglue={\hskip 0pt plus 0.08\baselineskip}}
}
% è¿™æ ·å¯é¿å…åœ¨æ˜¾ç¤ºä»£ç æ—¶ä¸­è‹±æ–‡ä¹‹é—´å‡ºç°ä¸å¿…è¦çš„ç©ºæ ¼ã€‚
\end{examcode}

è¯†åˆ«è¡Œå†…æ•°å­¦å…¬å¼ï¼š
\begin{examcode}{}
\texhighverb!å…¬å¼ $ \int_a^b x^2 dx = \frac{1}{3} x^3 |_a^b $!ã€‚
\end{examcode}

æ¸å˜ï¼š
\begin{examcode}[texhigh options={use-ctab=latex3}]{}
\texhighverb[style=tikz.gradient, use-ctab=latex3, config-file=config.cfg]|\sys_get_shell:nnNTF|
\end{examcode}

åº•çº¹ï¼š
\begin{examcode}[texhigh options={use-ctab=latexcode, lexer-catcode*={9}{10}{explon}}]{}
\makeatletter
% #1: tikz options, #2: text
\def\myshadetext#1#2{\texhigh@shadetext{#1}{\bfseries #2}}
\makeatother
{\LARGE
% åœ¨åŠ è½½ texhigh ä¹‹å‰åŠ è½½ tikz å®åŒ…ï¼
% ä½¿ç”¨ grass.png ä½œä¸ºæ–‡å­—åº•çº¹ï¼Œä¾èµ– tikz çš„ fill.image åº“ï¼Œä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ªåº“ã€‚
\texhighverb[use-ctab=latex3, this-cs=\myshadetext{fill stretch image=grass.png}]
|\sys_get_shell:nnNTF| 
}
\end{examcode}

ä¸­æ–‡å‘½ä»¤è¯†åˆ«ï¼ˆ\TeX åŸè¯­å¸¦æœ‰ä¸‹åˆ’çº¿ï¼‰ï¼š
\begin{examcode}[texhigh use ctab=cjk]{}
\begin{texhigh}[output=\jobname.texhigh, use-ctab=cjk]
  \def\å¥½å¥½å¥½{ä¸­æ–‡ Good}
  \å¥½å¥½å¥½\relax 
\end{texhigh}
\end{examcode}

ç±»åˆ«ç æ··åˆä½¿ç”¨ï¼š
\begin{examcode}[texhigh style=plain0, texhigh gobble]{}
% è‡ªåŠ¨æ£€æµ‹ \makeatletter å’Œ \ExplSyntaxOn å—ï¼Œ
% \makeatletter å’Œ \ExplSyntaxOn å¿…é¡»åœ¨è¡Œé¦–ï¼Œå‰é¢å¯ä»¥æœ‰ç©ºæ ¼
\begin{texhigh}[lexer-catcode={atletter, explon}]
\def\foo@#1{[#1]} \foo@{FOO} \@kernel
\makeatletter
\def\foo@:#1{[#1]} \foo@:#1{FOO} \@kernel \scan_stop:
\ExplSyntaxOn
\cs_set:Npn \foo@: #1 { [#1] }
\foo@: {FOO} \@kernel \scan_stop:
\ExplSyntaxOff
\@kernel \scan_stop:
\makeatother
\@kernel \scan_stop:
\end{texhigh}
\end{examcode}

ä¹Ÿå¯æ‰‹åŠ¨è°ƒæ•´ç±»åˆ«ç ï¼š
\begin{examcode}[texhigh style=plain0]{}
\begin{texhigh}[
  lexer-catcode*={3}{9}{@=11, ?=11}, % [3, 9) è¡Œï¼Œ@ å’Œ ? çš„ç±»åˆ«ç ä¸º 11
   % lexer-catcode*={3}{9}{ @?=11 }, % <- å¯ä»¥åˆå¹¶
  lexer-catcode*={5}{7}{explon},     % [5, 7) è¡Œï¼Œå¯ç”¨ expl3 çš„ç±»åˆ«ç 
]
\def\foo@#1{[#1]} \foo@{FOO} \@kernel
\makeatletter
\def\foo@:#1{[#1]} \foo@:#1{FOO} \@kerne? \scan_stop:
\ExplSyntaxOn
\cs_set:Npn \foo@: #1 { [#1] }
\foo@: {FOO} \@kernel \scan_stop:
\ExplSyntaxOff
\@kernel \scan_stop:
\makeatother
\@kernel \scan_stop:
\end{texhigh}
\end{examcode}

é™¤äº†ç”¨ use-ctab è®¾ç½®ä¸»ç±»åˆ«ç è¡¨ä»¥å¤–ï¼Œ
è¿˜å¯ä»¥æ·»åŠ é¢å¤–çš„ç±»åˆ«ç è¡¨ï¼Œä¼˜å…ˆé€‰æ‹©é åçš„ç±»åˆ«ç è¡¨ï¼š
\begin{examcode}[texhigh style=plain0]{}
\texhighverb[extra-catcode*=cjk, extra-catcode*=explon]
  {\cs_set:Npn \a_å¥½çš„: #1 { aaa } \a_å¥½çš„:}

% extra-catcode* å®é™…ç›¸å½“äºè®¾ç½® lexer-catcode* çš„å‰ä¸¤ä¸ªå€¼ä¸º {0}{}
% å³ï¼Œä»ç¬¬ 0 è¡Œå¼€å§‹ï¼Œæ°¸ä¸ç»“æŸ
\texhighverb[lexer-catcode*={0}{}{cjk}]{\def\aå¥½çš„#1{aaa} \aå¥½çš„}
\end{examcode}

è¿˜èƒ½è¿›ä¸€æ­¥ç»†åŒ–åˆ°åˆ—æ•°ï¼š
\begin{examcode}[texhigh style=plain0]{}
% 1 ç›¸å½“äº [1, 0]ï¼Œ
% [1, 9] è¡¨ç¤ºç¬¬ 1 è¡Œç¬¬ 9 ä¸ªå­—ç¬¦
% è¿™é‡Œå°±æ˜¯ä»ç¬¬ä¸€è¡Œçš„å¼€å§‹ï¼Œç›´åˆ°ç¬¬ä¸€è¡Œç¬¬ 9 ä¸ªå­—ç¬¦ï¼ˆä¸å«ï¼‰ï¼Œç©ºæ ¼çš„ç±»åˆ«ç ä¸º 0
% è®¾ç½®ç±»åˆ«ç æ—¶ï¼Œç‰¹æ®Šå­—ç¬¦å¿…é¡»è½¬ä¹‰ï¼Œå…¶å®ƒå­—ç¬¦å¯è½¬ä¹‰ä¹Ÿå¯ä¸è½¬ä¹‰
\texhighverb[lexer-catcode*={1}{[1,9]}{\ =0}]{abd def  #1{\space  }}
%                                      ^^--è½¬ä¹‰       ^--ç©ºæ ¼çš„ç±»åˆ«ç ä¸å†æ˜¯ 0

\texhighverb{abd def  #1"\space"}
\end{examcode}

\texttt{lexer-catcode*} çš„å‰ä¸¤ä¸ªå‚æ•°è¿˜æ”¯æŒæ›´åŠ å¤æ‚çš„æ¨¡å¼ï¼Œå¦‚çº¯æ–‡æœ¬æ­£åˆ™è¡¨è¾¾å¼ å’Œ \TeX æ­£åˆ™è¡¨è¾¾å¼ã€‚

ä¾‹å¦‚æ£€æµ‹ \texhighverb|\verb| å‘½ä»¤ï¼š
\begin{examcode}[texhigh gobble=auto]{}
  \texhighverb[lexer-catcode*={\c{verb}\*?\|}{\|}{str}]
    {a \verb|\macro in \verb| command \verb*|\macro in \verb| \macro}
\end{examcode}

çº¯æ–‡æœ¬æ­£åˆ™è¡¨è¾¾å¼å°±æ˜¯é’ˆå¯¹çº¯æ–‡æœ¬çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ—¥å¸¸è§åˆ°çš„æ­£åˆ™è¡¨è¾¾å¼éƒ½æ˜¯è¿™ä¸€ç±»ï¼Œ
texhigh æ”¯æŒçš„çº¯æ–‡æœ¬æ­£åˆ™è¡¨è¾¾å¼çš„å®Œæ•´è¯­æ³•è§ \url{https://docs.rs/regex/latest/regex/#syntax}ã€‚

\TeX æ­£åˆ™è¡¨è¾¾å¼æ˜¯é’ˆå¯¹ {\TeX} token çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œ\LaTeX3 çš„ \textsf{l3regex} å°±æ˜¯è¿™ç±»ï¼Œ
texhigh æ”¯æŒçš„ \TeX æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•å’Œ \textsf{l3regex} åŸºæœ¬ä¸€è‡´ï¼Œä½†æš‚ä¸æ”¯æŒ
\verb|\b| \verb|\B| \verb|\G| \verb|\u| è¿™å‡ ä¸ªè½¬ä¹‰åºåˆ—ï¼Œ
ä»¥åŠ \verb|\c| è½¬ä¹‰åºåˆ—çš„å¦å®šå½¢å¼ï¼ˆå³æš‚ä¸æ”¯æŒ \verb|[^\c{begin}\c{end}]| è¿™ç±»ç”¨æ³•ï¼‰ã€‚

\begin{examcode}[texhigh style=plain0, sidebyside, sidebyside gap=4mm, righthand width=62mm]{}
% \I æ”¾åœ¨å¼€å¤´è¡¨ç¤ºè¿™æ˜¯çº¯æ–‡æœ¬æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…æºç 
\begin{texhigh}[gobble=2, % æ¯è¡Œåˆ é™¤å‰ä¸¤ä¸ªå­—ç¬¦
  lexer-catcode*=
    {\I\\catcode`\\!=11[\s\\]}
    {\I\\endgroup\s}
    {!=11},
]
  \def\!mark#1{MARK1} \!mark
  \begingroup
    \catcode`\!=11
    \def\!mark#1{MARK2} \!mark
    \endgroupp \!mark
  \endgroup
  \!mark
\end{texhigh}
\end{examcode}

\begin{examcode}[texhigh style=plain0, sidebyside, sidebyside gap=4mm, righthand width=62mm]{}
% \T æ”¾åœ¨å¼€å¤´è¡¨ç¤ºè¿™æ˜¯ TeX æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é… token
% \T å¤§å¤šæ•°æ—¶å€™å¯ä»¥çœç•¥ï¼Œä½†å½“æ¨¡å¼ä»¥æ•°å­—æˆ– [ å¼€å¤´æ—¶ï¼Œ\T ä¸å¯çœç•¥ï¼Œå¦åˆ™è¢«å½“ä½œè¡Œå·
\begin{texhigh}[gobble=auto, % æ£€æµ‹ç©ºæ ¼å¹¶åˆ é™¤
  lexer-catcode*=
    {\T\c{catcode}\`\c{!}\=11} % æ³¨æ„å­—ç¬¦è½¬ä¹‰
    {\c{endgroup}}
    {!=11},
]
  \def\!mark#1{MARK1} \!mark
  \begingroup
    \catcode`\!=11
    \def\!mark#1{MARK2} \!mark
    \endgroupp \!mark
  \endgroup
  \!mark
\end{texhigh}
\end{examcode}

\texttt{lexer} ä¹Ÿå¯æ··åˆä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œè¡Œæ•°ï¼š
\begin{examcode}[texhigh style=plain0]{}
\begin{texhigh}[gobble=auto,
  lexer-catcode*={(^|\cJ.|\n)\c{ExplSyntaxOn}}{4}{\:\_=11},
]
  \ExplSyntaxOn
    \cs_set:Npn \expl_off: { \ExplSyntaxOff } \expl_off:
  \ExplSyntaxOff
  \expl_off:
\end{texhigh}
\end{examcode}

å¯ç”¨ä½¿ç”¨ \texttt{lines} è®¾ç½®æºæ–‡ä»¶éœ€è¦ä¿ç•™çš„è¡Œæ•°ï¼Œ\texttt{gobble=auto} æ£€æµ‹ç©ºæ ¼æ—¶åªä¼šæ£€æµ‹ä¿ç•™ä¸‹æ¥çš„ä»£ç è¡Œï¼š
\begin{examcode}[texhigh style=plain0, sidebyside, sidebyside gap=4mm, righthand width=62mm]{}
\begin{texhigh}[gobble=auto, % æ£€æµ‹ç©ºæ ¼å¹¶åˆ é™¤
  lines={2,8}, % åªä¿ç•™ [2, 8) è¡Œ
  lexer-catcode*=
    {\T\c{catcode}\`\c{!}\=11} % æ³¨æ„å­—ç¬¦è½¬ä¹‰
    {\c{endgroup}}
    {!=11},
]
      \kill this line
  \def\!mark#1{MARK1} \!mark
  \begingroup
    \catcode`\!=11
    \def\!mark#1{MARK2} \!mark
    \endgroupp \!mark
  \endgroup
  \!mark
\end{texhigh}
\end{examcode}

\begin{examcode}[texhigh style=plain0]{}
% \THSetCharReplacement{\ }{\textvisiblespace} % texhigh å·²è®¾ç½®
\THSetCharReplacement{\$}{\S} % æŠŠ $ æ›¿æ¢ä¸º \S
\texhighverb[char-replacements={\ \$}, % è®¾ç½®å“ªäº›å­—ç¬¦è¦æ›¿æ¢
  char-category*={symbol}{[\ \$]}{\mbox{\color{red}#1}}, % ä¿®æ”¹é¢œè‰²
] {\def\a #1{$#1$} \a {\ b}}
\end{examcode}

æ§åˆ¶åºåˆ—çš„åç§°é‡Œçš„å­—ç¬¦ä¹Ÿä¼šè¢«æ›¿æ¢ï¼š
\begin{examcode}[texhigh style=plain0]{}
\texhighverb[char-replacements={a=A, b=B, {=}={,}}]{abcd=$\abcd} % ä¸€æ­¥åˆ°ä½
% å­—ç¬¦æ›¿æ¢æ— éœ€å¯ç”¨å¢å¼ºæ¨¡å¼
\texhighverb[enhanced=false, char-replacements={a=A, b=B, {=}={,}}]
  {abcd=$\abcd}
\end{examcode}

\texttt{char-category} ä¹Ÿå¯ä»¥ç”¨æ¥æ›¿æ¢å­—ç¬¦ï¼Œä½†ä¸ä¼šæ›¿æ¢æ§åˆ¶åºåˆ—åç§°é‡Œçš„å­—ç¬¦ï¼š
\begin{examcode}[texhigh options={gobble=auto,lexer-catcode=explon,
  char-category*={emoji}{[\p{Emoji}--\p{ASCII}]}{\mbox{\emojifont #1}} % ASCII digit is emoji!
}]{}
  \ExplSyntaxOn
    \cs_new_protected:Npn \chartouni #1 { \fbox{ \int_to_Hex:n { `#1 }} }
  \ExplSyntaxOff
  \texhighverb[
    % è¿™é‡Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾å­—ç¬¦çš„ç±»åˆ«ï¼Œä¸‹é¢çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ˜¯ Emoji ä½†ä¸æ˜¯ ASCII çš„å­—ç¬¦
    char-category*={emoji}{[\p{Emoji}--\p{ASCII}]}{\chartouni{#1}\ }
  ] {Emoji: ğŸ€ğŸƒğŸ…ğŸ‡ğŸ‰ğŸğŸğŸğŸ’ğŸ“ğŸ•ğŸ–}
\end{examcode}

å¯ä»¥ä½¿ç”¨ \texttt{line-number} é€‰é¡¹æ¥ä¸ºä»£ç åŠ ä¸Šè¡Œå·ï¼Œ\texttt{first-line-number} å¯ä»¥è®¾ç½®èµ·å§‹è¡Œå·ã€‚
\begin{examcode}{}
\begin{texhigh}[gobble=auto, line-number, first-line-number=42,
  line-number-format={\color[gray]{0.5}\scriptsize\sffamily #1},
  left-space=5mm, right-space=5mm,
]
  \documentclass{article}
  \usepackage[paper=a4,hmargin=2cm]{geometry} % é¡µé¢è®¾ç½®
  \usepackage{fancyhdr} % é¡µçœ‰
  \begin{document}
    Hello, \LaTeXe.
  \end{document}
\end{texhigh}
\end{examcode}

\textsf{texhigh} æ”¯æŒä¸ \textsf{listings} å’Œ \textsf{minted} ç±»ä¼¼çš„åœ¨é«˜äº®æ—¶è®©æŸäº›è®°å·ä¿æŒå…¶åŸæœ‰ä½œç”¨çš„ç‰¹æ€§ã€‚
\begin{examcode}{}
\begin{texhigh}[texcl, escape-inside=||, escape-inside=\ES, gobble=auto]
  % This \textbf{comment} line \emph{will be} escaped.
  This \textbf{text} line \ES{\emph{won't} be} escaped.
  This |\textbf{will}| be escaped.
\end{texhigh}
\end{examcode}

\begin{examcode}{}
\begin{texhigh}[gobble=auto, texcl, math-escape, % å…è®¸è¾“å‡ºè¡Œå†…å…¬å¼
  linenos, first-line-number=1, % texhigh ä¸ä¼šè‡ªåŠ¨é‡è®¾è¡Œå·
  left-space=5mm, line-number-pos=left, % è¡Œå·ä½ç½®ï¼šleft, right, both
]
  A expression $\displaystyle\int\sin x\mathrm{d}x=-\cos x+C$.
  Another equation \(\sum\limits_{n=0}^{+\infty}\dfrac{1}{n^2}=\dfrac{\pi^2}{6}\).
  % The text \emph{will} be printed, so is the $E^2=(pc)^2+(m_0c^2)^2$ formula.
\end{texhigh}
\end{examcode}

\begin{examcode}{}
\begin{texhigh}[gobble=auto, line-number, line-number-pos=right,
  right-space=5mm, comments-math-escape, % åªå…è®¸æ³¨é‡Šå†…çš„æ•°å­¦å…¬å¼
]
  A expression $\displaystyle\int\sin x\mathrm{d}x=-\cos x+C$
  A expression % $\displaystyle\int\sin x\mathrm{d}x=-\cos x+C$
  A expression % \(\displaystyle\int\sin x\mathrm{d}x=-\cos x+C\)
\end{texhigh}
\end{examcode}

äº‹å®ä¸Šï¼Œå®ƒä»¬æœ‰æ›´é€šç”¨çš„å†™æ³•ï¼š
\begin{examcode}{}
\DeclareDocumentCommand\cs{O{\texttt}m}
  {#1{\textbackslash\detokenize{#2}}}
\DeclareDocumentCommand\pkg{m}{\textsf{#1}}
\begin{texhigh}[gobble=auto,
  % start ç”¨äºæ ‡è®°ä½•æ—¶å¼€å§‹ï¼Œä¸º TeX æ­£åˆ™è¡¨è¾¾å¼æˆ–çº¯æ–‡æœ¬æ­£åˆ™è¡¨è¾¾å¼æˆ–çº¯æ–‡æœ¬ï¼Œ
  % ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ—¶ä¸€å®šè¦æ³¨æ„å¸¦ç€å¼€å§‹é”šç‚¹ï¼ˆ^ï¼‰ï¼
  % arguments ç”¨äºæŒ‡ç¤ºå®ƒè·å–çš„å‚æ•°ï¼Œåƒ ltcmdï¼ˆxparseï¼‰å®šä¹‰å‘½ä»¤æ—¶ä½¿ç”¨çš„ä¸€æ ·
  % in-comments ç”¨äºè¡¨ç¤ºå®ƒæ˜¯å¦éœ€å¤„äºæ³¨é‡Šå†…ï¼Œæœ‰ä¸‰ä¸ªå¯é€‰å€¼ï¼šmustã€neverã€any
  range={cs}{escape, start=^\c{cs}, arguments=om, in-comments},
  range={pkg}{escape, start=^\c{pkg}, arguments=m},
]
  % The \cs{c_true_bool} is true in \pkg{l3bool}.
  The \cs{c_false_bool} is false in \pkg{l3bool}.
\end{texhigh}
\end{examcode}

\cs{THSetRange} å¯ä»¥ç”¨æ¥è®¾ç½®ä»£ç æ®µï¼ˆrangeï¼‰çš„æ ¼å¼ã€‚ç”¨æ³•å¦‚ä¸‹ï¼š

\noindent
\fbox{\cs{THSetRange}\marg{range id}\oarg{range settings}\marg{begin code}\oarg{end code}}

å½“ä¸ç»™å‡º \meta{range settings} æ—¶ï¼Œåªä¼šä¿®æ”¹æ ·å¼ï¼Œè€Œä¸ä¼šæ•è·ä»£ç æ®µã€‚

\begin{examcode}{}
\THSetRange{usepackage}
  [start=^\c{usepackage}, arguments=omo]
  {\THSetRange{argument.o}{\THcolor{blue}}%
    \THSetRange{argument.m}{\THcolor{cyan}\bfseries}}
% \usepackage{hologo}
% remove-start ç”¨äºç§»é™¤ start çš„å†…å®¹ï¼Œè¿™é‡Œ start æ•è· \AMSï¼Œ
% æŠŠ \AMS ç§»é™¤ï¼Œç„¶åè¾“å‡ºæˆ‘ä»¬è®¾ç½®çš„å†…å®¹ï¼Œè¿™é‡Œæ˜¯ \hologo{AmS}
\THSetRange{logo}[escape, start=^\c{AMS}, remove-start]{\hologo{AmS}}

\begin{texhigh}[gobble=auto,]
  \usepackage[width=210mm,height=297mm]{geometry}
  \usepackage{amsmath,amsthm} % \AMS packages
  \usepackage[xdvipdfmx]{color}[2025/06/01]
\end{texhigh}
\end{examcode}

\texttt{arguments} åŒ…æ‹¬ \texttt{m o O d D r R s t v} ä»¥åŠ
\texttt{l u g G}ï¼ˆå…¶ä¸­ \texttt{u} çš„å®šç•Œç¬¦åªèƒ½æœ‰ä¸€ä¸ªè®°å·ï¼Œä¸åƒ \textsf{xparse} é‚£æ ·æ”¯æŒå¤šä¸ªè®°å·ä½œä¸ºå®šç•Œç¬¦ï¼‰ï¼Œ
æš‚ä¸æ”¯æŒ \texttt{e E c b}ï¼Œå¹¶ä¸” \texttt{! + = >} ä¹Ÿæ˜¯æ— æ•ˆçš„ã€‚
æ­¤å¤–ï¼Œè¿˜æ”¯æŒä¸€ä¸ªç‰¹æ®Šçš„ç¬¦å· \verb|^^J|ï¼Œå®ƒç”¨äºæ•è·å½“å‰è¡Œå‰©ä¸‹çš„å†…å®¹ï¼Œå¸¦ä¸€ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºæ˜¯å¦è¦æ±‚å¤§æ‹¬å·æˆå¯¹å­˜åœ¨ã€‚
\begin{examcode}{}
\THSetRange{special}
  % \THmN æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°å‘½ä»¤ï¼Œç”¨æ¥è¡¨ç¤º ^^Jã€‚
  % ^^J çš„å‚æ•°â€œ1â€è¡¨ç¤ºå¤§æ‹¬å·å¿…é¡»æˆå¯¹å­˜åœ¨ã€‚
  % ç”±äº ^^J æ•è·äº†å½“å‰è¡Œçš„å‰©ä½™çš„å†…å®¹ï¼Œè¿™ä¹ŸåŒ…æ‹¬æ¢è¡Œï¼Œè¿™ä¼šå¯¼è‡´
  % æ¢è¡Œå‡ºç°åœ¨ range å†…éƒ¨ï¼Œæœ¬ä¾‹ä¸­é—®é¢˜ä¸å¤§ï¼Œä½†æŸäº›è‡ªå®šä¹‰çš„ range å°±ä¸ä¸€å®šäº†
  % insert-ending ç”¨æ¥æŠŠå®šç•Œç¬¦ï¼ˆè¿™é‡Œå°±æ˜¯æ¢è¡Œç¬¦ï¼‰â€œè¿”è¿˜â€å‡ºæ¥
  [start=^\c{SP}, arguments=l m \THmN{1}, insert-ending]
  {\THSetRange{argument.l}{\ensuremath{\lvert}}[\ensuremath{\rvert}]%
    \THSetRange{argument.m}{\ensuremath{\langle}}[\ensuremath{\rangle}]%
    \THSetRange{argument.^^J}{\ensuremath{\lVert}}[\ensuremath{\rVert}]}

\begin{texhigh}[gobble=auto]
  A \SP special {arguments} to the end.
  Another \SP fancy {parameter} of the line.
\end{texhigh}
\end{examcode}

æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æ³¨é‡Šçš„æ˜¾ç¤ºæ–¹å¼ï¼Œå°±æ˜¯ä½¿ç”¨ \verb|^^J| å‚æ•°ï¼š
\begin{examcode}{}
\THSetRange{comment-1}
  [start=\I^\%\s, arguments=\THmN{0}, insert-ending]
  {\THcolor[gray]{0.5}\THSetPlainStyle{cs,color}}%
  [{\color{yellow!70!green}\rmfamily\bfseries \dotfill SC.}]
\THSetRange{comment-2}
  [start=\I^\%e\ , escape, arguments=\THmN{1}, remove-start, use-argument, insert-ending]
  {\THcolor{red}\normalfont \textbf{SP: }}
\THSetRange{comment-3}
  [start=\I^\%a, escape, arguments=m \THmN{1}, remove-start, insert-ending]
  {\def\grab#1{{\rmfamily\bfseries #1:\ }\ignorespaces}%
    \THcolor{purple}\sffamily \grab}
\THSetRange{comment-4}
  [start={\L//\THmS}, arguments=\THmN{0}, insert-ending]
  {\THcolor{green!40!black}\textrm{C style comment: }}

\begin{texhigh}[gobble=auto]
  This is normal % comment(1).
  This is %e Some comment 2.
  %a{comment 3} is the line.
  // This is comment 4.
\end{texhigh}
\end{examcode}

ç”±äº range åœ¨æ•è·æ—¶ä¸èƒ½åµŒå¥—æ•è·ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„æ³¨é‡Šä¼šå¯¼è‡´å®ƒå†…éƒ¨æ— æ³•æ•è·å…¶å®ƒ range äº†ã€‚
ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯å°†æ­¤ range è®¾ç½®ä¸º \texttt{escape}ï¼Œç„¶åå†…éƒ¨å†ä½¿ç”¨ \cs{texhighverb}ã€‚
\begin{examcode}{}
\THSetRange{mycomment}
  % ä½¿ç”¨ insert-brace ä¼šæŠŠæ‰€æœ‰å‚æ•°æ”¾åˆ°ä¸€ä¸ªå¤§æ‹¬å·é‡Œï¼Œ\THmS è¡¨ç¤ºç©ºæ ¼
  [start={\L//\THmS}, escape, arguments=\THmN{1}, remove-start, insert-brace, insert-ending]
  {% \appendpercent â€œå‚æ•°å¤„ç†å™¨â€æŠŠ \THmPï¼ˆå³â€œ%â€ï¼‰æ”¾åˆ°å‚æ•°çš„å‰é¢
    \def\appendpercent#1{\edef\ProcessedArgument{\THmP\unexpanded{#1}}}%
    \DeclareDocumentCommand{\mycommentverb}{>{\appendpercent} v}
      {\texhightext[remove-enabled-ranges={mycomment}]{#1}}%
    % å¦‚æœæ˜¯ç±»åˆ«ç ä¸º 14 ä¸”ä¸ºæ˜¯ç¬¬ä¸€ä¸ªâ€œ%â€å°±æ¢å› â€œ//\THmSâ€
    \def\firstComment#1{\if#1\THmP\relax //\THmS \def\firstComment{}\else #1\fi}%
    \THSetClassCH[]{catcode.14}{\firstComment{#1}}%
    \normalfont \mycommentverb}
\begin{texhigh}[gobble=auto, escape-inside=||]
  The |\LaTeX| % comment can be |\emph{highlighted}|.
  // also can be |\emph{highlighted}|, but isn't |\LaTeX|.
\end{texhigh}
\end{examcode}

\textsf{texhigh} é»˜è®¤çš„å®šä¹‰ä»¥åŠéƒ¨åˆ†å‘½ä»¤çš„ç”¨æ³•å¯å‚è€ƒ \texttt{texhigh.prelude.ths} æ–‡ä»¶ã€‚

\small

% \bigskip
% \noindent\texhighverb|%%% ä»¥ä¸‹è¾“å‡ºæœ¬æ–‡æºç  %%%|
% \texhighfile[style=tikz.gradient, use-ctab=cjkl3]{\jobname.tex}
% \noindent\texhighverb|%%% ä»¥ä¸Šæ˜¯æœ¬æ–‡æºç  %%%|

% \vspace{1cm}
% \noindent\texhighverb|%%%---- File: texhigh.sty ----%%%|
% \texhighfile[use-ctab=latex3code, config-file=config.cfg]{texhigh.sty}

\vspace{1cm}
\noindent\texhighverb|%%%---- File: texhigh.prelude.ths ----%%%|
\texhighfile[use-ctab=latexcode]{texhigh.prelude.ths}

% \newpage
% \newgeometry{hmargin=1cm, top=1.5cm, bottom=1.2cm}
% \texhighfile[use-ctab=latex3code,enhanced,font+=\small]{expl3-code.tex}

\end{document}