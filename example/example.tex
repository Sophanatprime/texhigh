% !TEX program=xelatex
% !TEX options=-synctex=1 -shell-escape -interaction=nonstopmode -file-line-error "%DOC%"
\documentclass[zihao=-4,fontset=fandol]{ctexart}
\usepackage[hmargin=2cm,vmargin=2.4cm]{geometry}
\usepackage[many]{tcolorbox}
\usepackage[color,tikz]{texhigh}
\ifdefined\xeCJKsetup
  \SetKeys[texhigh/high]{
    font=\ttfamily\xeCJKsetup{CJKecglue={\hskip 0pt plus 0.08\baselineskip}}
  }
\else
  \SetKeys[texhigh/high]{
    font=\ttfamily
  }
\fi
\newfontfamily\emojifont{Noto Emoji}
% è‹¥ç³»ç»Ÿæ²¡æœ‰è¿™äº›å­—ä½“ä¼šè‡ªåŠ¨å¿½ç•¥
\SetKeys[texhigh/layout]{fonts={Segoe UI,Segoe UI Symbol,Arial,Microsoft YaHei UI,PingFang SC,FandolHei}}
\SetKeys[texhigh/high]{cache-dir=texhigh-cache/} % cache-dir ä¸è¦å¿˜è®°åŠ  /
\tcbset{listing engine=texhigh, listing file=texhigh-cache/\jobname.listing}
\newcounter{example}
\newtcblisting[use counter=example, number format=\arabic]
  {examcode}[2][]{listing and text, 
  title=ä»£ç  \thetcbcounter, enhanced,
  comment={#2},
  left=2mm, right=2mm, top=2mm, bottom=2mm,
  sharp corners=downhill, arc=12pt, %skin=bicolor,
  fontupper=\linespread{1}\selectfont, left=6pt,
  colback=blue!1!white, colframe=blue!75!black,colbacklower=white,
  segmentation style={draw=blue,thick,solid},
  attach boxed title to top right={yshift=-\tcboxedtitleheight},
  boxed title style={
    colframe=blue!75!black,colback=blue!15!white,
    sharp corners=downhill,arc=12pt,
  },
  coltitle=blue!90!black, fonttitle=\bfseries,
  before skip balanced=2bp plus .5\baselineskip,
  after skip balanced=2bp plus .5\baselineskip,
  breakable,
  #1
}
\begin{document}

\title{é«˜äº® \TeX å’Œ \LaTeX3 ä»£ç â€”â€”ä½¿ç”¨\textsf{texhigh} å®åŒ…}
\author{é›¾æœˆ\thanks{longaster@163.com}}
\maketitle

\textsf{texhigh} å®åŒ…æ˜¯ä¸“ç”¨æ¥é«˜äº® \TeX æ–‡ä»¶çš„å®åŒ…ã€‚åŸºäºç”± Rust ç¼–å†™çš„å‘½ä»¤è¡Œå·¥å…·
texhigh\footnote{https://github.com/Sophanatprime/texhigh-rs}ï¼Œ
å¤„ç† 1.24MB å·¦å³ï¼ˆ37,700 ä½™è¡Œï¼‰çš„ \texttt{expl3-code.tex} åªéœ€ 0.16s å·¦å³
ï¼ˆæ“ä½œç³»ç»Ÿä¸º Windowsï¼ŒCPU ä¸º i7-12700Hï¼‰ï¼Œ
å¤„ç†é€Ÿåº¦çº¦ä¸º \textsf{minted} å®åŒ…ä½¿ç”¨çš„ pygmentize çš„ 17 å€ï¼Œ
texhigh çš„å¢å¼ºæ¨¡å¼ä¹Ÿæ¯”å®ƒå¿« 10 åˆ° 15 å€ã€‚
å¯¹äºæ™®é€šå¤§å°çš„ \TeX ä»£ç ï¼Œå¤„ç†å®ƒä»¬æ‰€éœ€çš„æ—¶é—´ç›¸æ¯”äº \TeX æ–‡ä»¶æœ¬èº«ç¼–è¯‘æ‰€éœ€çš„æ—¶é—´ï¼Œ
å·²ç»å¯ä»¥å¿½ç•¥ä¸è®°ã€‚

\textsf{texhigh} ä¸»è¦æ˜¯åœ¨ \LaTeX ä¸­ä¸º texhigh å‘½ä»¤è¡Œå·¥å…·æä¾›äº¤äº’æ¥å£ã€‚è¿™è¦æ±‚åœ¨ç¼–è¯‘ \TeX
æ–‡ä»¶æ—¶å¯ç”¨ \texttt{--shell-escape}ã€‚

\textsf{texhigh} å¯ä»¥è¾“å‡ºé¢œæ–‡å­—ï¼š
\kaomoji{Îµ(â”¬â”¬ï¹â”¬â”¬)3} ï¼Œåªéœ€ä½¿ç”¨ \texhighverb{\kaomoji}\texttt\{\ensuremath{\langle}\verb|é¢œæ–‡å­—|\ensuremath{\rangle}\texttt\}ã€‚
é»˜è®¤ä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼Œä¹Ÿå¯è‡ªè¡Œè®¾ç½® \kaomoji{ãƒ¾(â‰§â–½â‰¦*)o}ã€‚

% https://emojicombos.com/cute-kaomoji
\kaomoji{à¬˜(à©­*ËŠáµ•Ë‹)à©­* à©ˆâ™¡â€§â‚ŠËš}\quad
\kaomoji{ à¬ª(à¹‘â€¢á´—â€¢à¹‘)à¬“ â™¡}\quad
\kaomoji{ à«®â‚Ë¶ â€¢. â€¢ â‘…â‚áƒ â™¡}\quad
% \kaomoji{à»’ê’°â à¾€à½²áµ” áµ• áµ” ê’±â à¾€à½²à§§}\quad
\kaomoji{à»’ê’°â à¾€à½²â€†áµ” áµ• áµ”ê’±â à¾€à½²à§§}\quad
\kaomoji{(â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»}

% ç”±äº texhigh ä½¿ç”¨çš„ cosmic-text åº“åœ¨å¤„ç† font fallback æ—¶ä»æœ‰ç¼ºé™·ï¼Œ
ä½¿ç”¨é¢œæ–‡å­—æ—¶å¯èƒ½ä¼šé‡åˆ°å­—ä½“é—®é¢˜ï¼Œè¿™æ—¶åœ¨å­—ç¬¦é—´æ’å…¥é›¶å®½è¯è¿æ¥ç¬¦ \texttt{U+2060} æˆ–å¯è§£å†³ã€‚
% è¿™ä¼šå½±å“å­—ç°‡çš„åˆ†å‰²ï¼Œä»è€Œä¸ºæŸäº›å­—ç¬¦æŸ¥æ‰¾æ›´åŠ åˆé€‚çš„å­—ä½“ã€‚

ä½¿ç”¨ \texhighverb|\kaomoji*| è¿˜æ”¯æŒæŠŠå•è¡Œæ–‡å­—è¾“å‡ºä¸ºå›¾ç‰‡ï¼š
\begin{examcode}[texhigh options={
  char-category={emoji}{[\p{Emoji}--\p{ASCII}]}{\mbox{\emojifont #1}} % ASCII digit is emoji!
}]{}
% è¿™é‡Œçš„ fontsize å½±å“å›¾ç‰‡çš„å¤§å°ï¼Œä»è€Œå½±å“æ¸…æ™°åº¦
\kaomoji*[fontsize*=\Huge]{ğŸ€ğŸƒğŸ…ğŸ‡ğŸ‰ğŸğŸğŸğŸ’ğŸ“ğŸ•ğŸ–}{\includegraphics[height=12bp]}

\kaomoji*[fontsize=50bp]{\Uchar"1F43C }{\includegraphics[height=25bp]}
\end{examcode}

ä¹Ÿå¯ä»¥è‡ªå·±å°è£…ä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ï¼š
\begin{examcode}[texhigh options={
  use-ctab=latexcode,
  char-category={emoji}{[\p{Emoji}--\p{ASCII}]}{\mbox{\emojifont #1}} % ASCII digit is emoji!
}]{}
\makeatletter
\NewDocumentCommand\inmoji{ D<>{\f@size\p@} ={fonts+} O{} m }
  {\kaomoji*[fontsize={(#1)*3},#2]{#3}
    {\includegraphics[height=\dimeval{#1}]}}
\makeatother
\inmoji{ğŸ•ğŸ•‘ğŸ•’ğŸ•“ğŸ•”ğŸ••ğŸ•–ğŸ•—ğŸ•˜ğŸ•™ğŸ•šğŸ•›} \inmoji{^o^y}
\end{examcode}

\textsf{texhigh} æä¾› \texhighverb|\texhighverbã€\texhighfileã€\texhighinput|
è¿™å‡ ä¸ªå‘½ä»¤ä»¥åŠä¸€ä¸ª \textsf{texhigh} ç¯å¢ƒç”¨äºé«˜äº® \TeX ä»£ç ã€‚

\textsf{texhigh} è¿˜æœ‰å¾ˆå¼ºçš„å¯é…ç½®æ€§ã€‚

ä¸ºäº†å®ç°å¤„ç† \TeX æºç ä¸è¾“å‡ºç»“æœçš„åˆ†ç¦»ï¼Œ\textsf{texhigh} ä½¿ç”¨â€œç±»å‹â€å’Œâ€œç±»åˆ«â€æ¥åŒºåˆ†ä¸åŒçš„è®°å·ã€‚
å­—ç¬¦å’Œæ§åˆ¶åºåˆ—æ˜¯ä¸åŒçš„â€œç±»å‹â€ï¼Œæ§åˆ¶åºåˆ—ä¹‹é—´å¯ä»¥æœ‰ä¸åŒçš„â€œç±»åˆ«â€ï¼Œä¾‹å¦‚æ˜¯åŸè¯­ã€\LaTeX3 å‡½æ•°ç­‰ã€‚
ç±»å‹ä¸å¯æ”¹å˜ï¼Œè€Œâ€œç±»åˆ«â€å¯ä»¥è‡ªç”±ä¿®æ”¹ã€‚

æ¯ä¸ªç±»å‹éƒ½æœ‰ä¸€äº›å‘½ä»¤ç”¨äºæ›´æ”¹å®ƒä»¬çš„â€œç±»åˆ«â€çš„æ˜¾ç¤ºæ•ˆæœï¼Œå¦‚ï¼Œå¯¹äºä¸€ä¸ªæ§åˆ¶åºåˆ—ï¼Œå¯ä»¥ä½¿ç”¨
\texhighverb|\THSetClassCS| æ”¹å˜æ˜¾ç¤ºæ•ˆæœã€‚å¯ä»¥ä¸ºå®ƒä»¬è®¾ç½®å‰æ™¯è‰²ã€èƒŒæ™¯è‰²ï¼Œ
ç”šè‡³æ¸å˜è‰²å’Œåº•çº¹ç­‰ç­‰ã€‚å®é™…ä¸Šæ™®é€šæ–‡å­—å¯ä»¥æ˜¾ç¤ºæˆä»€ä¹ˆæ•ˆæœï¼Œå®ƒä»¬å°±å¯ä»¥åšåˆ°åŒæ ·çš„æ•ˆæœã€‚
å…·ä½“ä¿®æ”¹æ–¹å¼å¯ä»¥å‚è€ƒæ–‡æœ« \texttt{basic} æ ·å¼çš„æºç ã€‚

\textsf{texhigh} åˆ©ç”¨ \textsf{tikz} å®ç°äº†æ¸å˜å’Œåº•çº¹æ•ˆæœï¼ŒåŒæ—¶ä¹Ÿå¯ç›´æ¥é›†æˆåˆ°
\textsf{tcolorbox} å®åŒ…ä¸­ã€‚åªéœ€è¦åœ¨åŠ è½½ \textsf{texhigh} ä¹‹å‰åŠ è½½è¿™å‡ ä¸ªå®åŒ…ã€‚
\begin{examcode}[listing only]{}
\usepackage{tikz}
\usepackage{tcolorbox}
\usepackage{texhigh}
\tcbset{listing engine=texhigh} % ä½¿ç”¨è¿™ä¸ªå³å¯åˆ‡æ¢è‡³ texhigh 
% è‹¥ä½¿ç”¨ xeCJKï¼Œå³åœ¨ XeLaTeX ä¸­ä½¿ç”¨ ctexï¼Œæœ€å¥½è®¾ç½®
\SetKeys[texhigh/high]{
  font=\ttfamily\xeCJKsetup{CJKecglue={\hskip 0pt plus 0.08\baselineskip}}
}
% è¿™æ ·å¯é¿å…åœ¨æ˜¾ç¤ºä»£ç æ—¶ä¸­è‹±æ–‡ä¹‹é—´å‡ºç°ä¸å¿…è¦çš„ç©ºæ ¼ã€‚
\end{examcode}

è¯†åˆ«è¡Œå†…æ•°å­¦å…¬å¼ï¼š
\begin{examcode}{}
\texhighverb!å…¬å¼ $ \int_a^b x^2 dx = \frac{1}{3} x^3 |_a^b $!ã€‚
\end{examcode}

æ¸å˜ï¼š
\begin{examcode}[texhigh options={use-ctab=latex3}]{}
\texhighverb[style=tikz.gradient, use-ctab=latex3, config-file=config.cfg]|\sys_get_shell:nnNTF|
\end{examcode}

åº•çº¹ï¼š
\begin{examcode}[texhigh options={use-ctab=latexcode, lexer-catcode*={9}{10}{explon}}]{}
\makeatletter
% #1: tikz options, #2: text
\def\myshadetext#1#2{\texhigh@shadetext{#1}{\bfseries #2}}
\makeatother
{\LARGE
% åœ¨åŠ è½½ texhigh ä¹‹å‰åŠ è½½ tikz å®åŒ…ï¼
% ä½¿ç”¨ grass.png ä½œä¸ºæ–‡å­—åº•çº¹ï¼Œä¾èµ– tikz çš„ fill.image åº“ï¼Œä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ªåº“ã€‚
\texhighverb[use-ctab=latex3, this-cs=\myshadetext{fill stretch image=grass.png}]
|\sys_get_shell:nnNTF| 
}
\end{examcode}

ä¸­æ–‡å‘½ä»¤è¯†åˆ«ï¼ˆ\TeX åŸè¯­å¸¦æœ‰ä¸‹åˆ’çº¿ï¼‰ï¼š
\begin{examcode}[texhigh use ctab=cjk]{}
\begin{texhigh}[output=\jobname.texhigh, use-ctab=cjk]
  \def\å¥½å¥½å¥½{ä¸­æ–‡ Good}
  \å¥½å¥½å¥½\relax 
\end{texhigh}
\end{examcode}

ç±»åˆ«ç æ··åˆä½¿ç”¨ï¼š

\begin{examcode}[texhigh style=plain0, texhigh gobble]{}
% è‡ªåŠ¨æ£€æµ‹ \makeatletter å’Œ \ExplSyntaxOn å—ï¼Œ
% ä½† \makeatletter è¿™å‡ ä¸ªå‘½ä»¤å¿…éœ€åœ¨è¡Œé¦–ï¼Œå‰é¢å¯ä»¥æœ‰ç©ºæ ¼
\begin{texhigh}[lexer-catcode={atletter, explon}]
\def\foo@#1{[#1]} \foo@{FOO} \@kernel
\makeatletter
\def\foo@:#1{[#1]} \foo@:#1{FOO} \@kernel \scan_stop:
\ExplSyntaxOn
\cs_set:Npn \foo@: #1 { [#1] }
\foo@: {FOO} \@kernel \scan_stop:
\ExplSyntaxOff
\@kernel \scan_stop:
\makeatother
\@kernel \scan_stop:
\end{texhigh}
\end{examcode}

ä¹Ÿå¯æ‰‹åŠ¨è°ƒæ•´ç±»åˆ«ç ï¼š
\begin{examcode}[texhigh style=plain0]{}
\begin{texhigh}[
  lexer-catcode*={3}{9}{@=11, ?=11}, % [3, 9) è¡Œï¼Œ@ å’Œ ? çš„ç±»åˆ«ç ä¸º 11
   % lexer-catcode*={3}{9}{ @?=11 }, % <- å¯ä»¥åˆå¹¶
  lexer-catcode*={5}{7}{explon},     % [5, 7) è¡Œï¼Œå¯ç”¨ expl3 çš„ç±»åˆ«ç 
]
\def\foo@#1{[#1]} \foo@{FOO} \@kernel
\makeatletter
\def\foo@:#1{[#1]} \foo@:#1{FOO} \@kerne? \scan_stop:
\ExplSyntaxOn
\cs_set:Npn \foo@: #1 { [#1] }
\foo@: {FOO} \@kernel \scan_stop:
\ExplSyntaxOff
\@kernel \scan_stop:
\makeatother
\@kernel \scan_stop:
\end{texhigh}
\end{examcode}

é™¤äº†ç”¨ use-ctab è®¾ç½®ä¸»ç±»åˆ«ç è¡¨ä»¥å¤–ï¼Œ
è¿˜å¯ä»¥æ·»åŠ é¢å¤–çš„ç±»åˆ«ç è¡¨ï¼Œä¼˜å…ˆé€‰æ‹©é åçš„ç±»åˆ«ç è¡¨ï¼š
\begin{examcode}[texhigh style=plain0]{}
\texhighverb[extra-catcode*=cjk, extra-catcode*=explon]
  {\cs_set:Npn \a_å¥½çš„: #1 { aaa } \a_å¥½çš„:}

% extra-catcode* å®é™…ç›¸å½“äºè®¾ç½® lexer-catcode* çš„å‰ä¸¤ä¸ªå€¼ä¸º {0}{}
% å³ï¼Œä»ç¬¬ 0 è¡Œå¼€å§‹ï¼Œæ°¸ä¸ç»“æŸ
\texhighverb[lexer-catcode*={0}{}{cjk}]{\def\aå’Œçš„#1{aaa} \aå¥½çš„}
\end{examcode}

è¿˜èƒ½è¿›ä¸€æ­¥ç»†åŒ–åˆ°åˆ—æ•°ï¼š
\begin{examcode}[texhigh style=plain0]{}
% 1 ç›¸å½“äº [1, 0]ï¼Œ
% [1, 9] è¡¨ç¤ºç¬¬ 1 è¡Œç¬¬ 9 ä¸ªå­—ç¬¦
% è¿™é‡Œå°±æ˜¯ä»ç¬¬ä¸€è¡Œçš„å¼€å§‹ï¼Œç›´åˆ°ç¬¬ä¸€è¡Œç¬¬ 9 ä¸ªå­—ç¬¦ï¼ˆä¸å«ï¼‰ï¼Œç©ºæ ¼çš„ç±»åˆ«ç ä¸º 0
% è®¾ç½®ç±»åˆ«ç æ—¶ï¼Œç‰¹æ®Šå­—ç¬¦å¿…é¡»è½¬ä¹‰ï¼Œå…¶å®ƒå­—ç¬¦å¯è½¬ä¹‰ä¹Ÿå¯ä¸è½¬ä¹‰
\texhighverb[lexer-catcode*={1}{[1,9]}{\ =0}]{abd def  #1{\space  }}
%                                      ^^--è½¬ä¹‰       ^--ç©ºæ ¼çš„ç±»åˆ«ç ä¸å†æ˜¯ 0

\texhighverb{abd def  #1"\space"}
\end{examcode}

\texttt{lexer-catcode*} çš„å‰ä¸¤ä¸ªå‚æ•°è¿˜æ”¯æŒæ›´åŠ å¤æ‚çš„æ¨¡å¼ï¼Œå¦‚å­—ç¬¦ä¸²æ­£åˆ™è¡¨è¾¾å¼ å’Œ \TeX æ­£åˆ™è¡¨è¾¾å¼ï¼š
\begin{examcode}[texhigh style=plain0, sidebyside, sidebyside gap=4mm, righthand width=62mm]{}
% \I æ”¾åœ¨å¼€å¤´è¡¨ç¤ºè¿™æ˜¯å­—ç¬¦ä¸²æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…æºç 
\begin{texhigh}[gobble=2, % æ¯è¡Œåˆ é™¤å‰ä¸¤ä¸ªå­—ç¬¦
  lexer-catcode*=
    {\I\\catcode`\\!=11[\s\\]}
    {\I\\endgroup\s}
    {!=11},
]
  \def\!mark#1{MARK1} \!mark
  \begingroup
    \catcode`\!=11
    \def\!mark#1{MARK2} \!mark
    \endgroupp \!mark
  \endgroup
  \!mark
\end{texhigh}
\end{examcode}

\begin{examcode}[texhigh style=plain0, sidebyside, sidebyside gap=4mm, righthand width=62mm]{}
% \T æ”¾åœ¨å¼€å¤´è¡¨ç¤ºè¿™æ˜¯ TeX æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é… token
% \T å¤§å¤šæ•°æ—¶å€™å¯ä»¥çœç•¥ï¼Œä½†å½“æ¨¡å¼ä»¥æ•°å­—æˆ– [ å¼€å¤´æ—¶ï¼Œ\T ä¸å¯çœç•¥ï¼Œå¦åˆ™è¢«å½“ä½œè¡Œå·
\begin{texhigh}[gobble=auto, % æ£€æµ‹ç©ºæ ¼å¹¶åˆ é™¤
  lexer-catcode*=
    {\T\c{catcode}\`\c{!}\=11} % æ³¨æ„å­—ç¬¦è½¬ä¹‰
    {\c{endgroup}}
    {!=11},
]
  \def\!mark#1{MARK1} \!mark
  \begingroup
    \catcode`\!=11
    \def\!mark#1{MARK2} \!mark
    \endgroupp \!mark
  \endgroup
  \!mark
\end{texhigh}
\end{examcode}

\begin{examcode}[texhigh style=plain0, sidebyside, sidebyside gap=4mm, righthand width=62mm]{}
\begin{texhigh}[gobble=auto, % æ£€æµ‹ç©ºæ ¼å¹¶åˆ é™¤
  lines={2,8}, % åªä¿ç•™ [2, 8) è¡Œ
  lexer-catcode*=
    {\T\c{catcode}\`\c{!}\=11} % æ³¨æ„å­—ç¬¦è½¬ä¹‰
    {\c{endgroup}}
    {!=11},
]
      \kill this line
  \def\!mark#1{MARK1} \!mark
  \begingroup
    \catcode`\!=11
    \def\!mark#1{MARK2} \!mark
    \endgroupp \!mark
  \endgroup
  \!mark
\end{texhigh}
\end{examcode}

\begin{examcode}[texhigh style=plain0]{}
% \THSetCharReplacement{\ }{\textvisiblespace} % texhigh å·²è®¾ç½®
\THSetCharReplacement{\$}{\S} % æŠŠ $ æ›¿æ¢ä¸º \S
\texhighverb[char-replacements={\ \$}, % è®¾ç½®å“ªäº›å­—ç¬¦è¦æ›¿æ¢
  char-category={symbol}{[\ \$]}{\mbox{\color{red}#1}}, % ä¿®æ”¹é¢œè‰²
] {\def\a #1{$#1$} \a {\ b}}

\texhighverb[char-replacements={a=A, b=B, {=}={,}}]{abcd=$}
\end{examcode}

% \bigskip
% \noindent\texhighverb|%%% ä»¥ä¸‹è¾“å‡ºæœ¬æ–‡æºç  %%%|
% \texhighfile[style=tikz.gradient, use-ctab=cjkl3]{\jobname.tex}
% \noindent\texhighverb|%%% ä»¥ä¸Šæ˜¯æœ¬æ–‡æºç  %%%|

% \vspace{1cm}
% \noindent\texhighverb|%%%---- File: texhigh.sty ----%%%|
% \texhighfile[use-ctab=latex3code, config-file=config.cfg]{texhigh.sty}

% \vspace{1cm}
% \noindent\texhighverb|%%%---- File: texhigh.prelude.ths ----%%%|
% \texhighfile[use-ctab=latexcode, config-file=config.cfg]{texhigh.prelude.ths}

% \newpage
% \newgeometry{hmargin=1cm, top=1.5cm, bottom=1.2cm}
% \texhighfile[use-ctab=latex3code,enhanced,font+=\small]{expl3-code.tex}

\end{document}